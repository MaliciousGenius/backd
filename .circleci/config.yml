# Golang CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-go/ for more details
version: 2
jobs:
  build:
    docker:
      # specify the version
      - image: circleci/golang:1.11.4
      
      # Specify service dependencies here if necessary
      # CircleCI maintains a library of pre-built images
      # documented at https://circleci.com/docs/2.0/circleci-images/
      # - image: circleci/postgres:9.4

    #### TEMPLATE_NOTE: go expects specific checkout path representing url
    #### expecting it in the form of
    ####   /go/src/github.com/circleci/go-tool
    ####   /go/src/bitbucket.org/circleci/go-tool
    working_directory: /go/src/github.com/backd-io/backd
    steps:
      - checkout

      - run: go test -v ./...

      - setup_remote_docker:
        docker_layer_caching: true

      - run: go get github.com/mitchellh/gox

      - run: gox -build-toolchain

      - run: for i in {admin,auth,backd,functions,objects,sessions}; do gox -osarch="linux/amd64" -output="bin/{{.Dir}}" github.com/backd-io/backd/cmd/$i ; done

        # login
      - run: docker login -u $DOCKER_USER -p $DOCKER_PASS

      - run: > 
        PROJECT_REPO="github.com/backd-io/backd"
        
        GIT_COMMIT=$(git rev-parse HEAD)

        for i in {admin,auth,backd,functions,objects,sessions} ; do
        
          docker build --force-rm --squash                         \
            -f scripts/Dockerfile                             \
            --build-arg ARTIFACT=${i}                              \
            --build-arg VCS_URL=${PROJECT_REPO}                    \
            --build-arg VCS_REF=${GIT_COMMIT}                      \
            --build-arg BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"` \
            --build-arg VERSION=latest                             \
            -t backd/$i:latest
        
          docker push backd/${i}:latest

        done

